<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="BoardMapper">

	<resultMap id="boardResultMap" type="Board">
		<result column="BOARD_NO" property="boardNo"/>
		<result column="BOARD_TYPE" property="boardType"/>
		<result column="CATEGORY_NO" property="categoryNo"/>
		<result column="CATEGORY_NAME" property="categoryName"/>
		<result column="BOARD_TITLE" property="boardTitle"/>
		<result column="BOARD_CONTENT" property="boardContent"/>
		<result column="BOARD_WRITER" property="boardWriter"/>
		<result column="MEMBER_ID" property="memberId"/>
		<result column="COUNT" property="count"/>
		<result column="CREATE_DATE" property="createDate"/>
	</resultMap>

	<resultMap id="attachmentResultMap" type="Attachment">
		<result column="FILE_NO" property="fileNo"/>
		<result column="REF_BNO" property="refBoardNo"/>
		<result column="ORIGIN_NAME" property="originName"/>
		<result column="CHANGE_NAME" property="changeName"/>
		<result column="FILE_PATH" property="filePath"/>
		<result column="FILE_LEVEL" property="fileLevel"/>
	</resultMap>
	
	<resultMap id="categoryResultMap" type="Category">
		<result column="CATEGORY_NO" property="categoryNo"/>
		<result column="CATEGORY_NAME" property="categoryName"/>
	</resultMap>

	<resultMap id="replyResultMap" type="Reply">
		<result column="REPLY_NO" property="replyNo"/>
		<result column="REF_BNO" property="refBoardNo"/>
		<result column="REPLY_WRITER" property="replyWriter"/>
		<result column="REPLY_CONTENT" property="replyContent"/>
		<result column="MEMBER_ID" property="memberId"/>
		<result column="CREATE_DATE" property="createDate"/>
	</resultMap>
	
	<select id="selectAllBoardCount" resultType="_int">
		SELECT COUNT(*)
		FROM BOARD
		WHERE STATUS = 'Y'
	</select>
	<select id="searchBoardCount" resultType="_int">
		SELECT COUNT(*)
		 FROM BOARD B
		 JOIN MEMBER M ON(BOARD_WRITER = MEMBER_NO)
		 WHERE B.STATUS = 'Y'
		 <choose>
		 	<when test="condition == 'writer'">
		 		AND MEMBER_ID
		 	</when>
		 	<when test="condition == 'title'">
		 		AND BOARD_TITLE
		 	</when>
		 	<otherwise>
		 		AND BOARD_CONTENT
		 	</otherwise>
		 </choose>
		  LIKE '%${keyword}%'
	</select>
	<select id="selectAllBoard" resultMap="boardResultMap">
		SELECT  BOARD_NO, 
                CATEGORY_NAME,
                BOARD_TITLE,
                MEMBER_ID,
                COUNT,
                TO_CHAR(CREATE_DATE, 'YYYY-MM-DD') AS "CREATE_DATE"
        FROM BOARD B
        JOIN CATEGORY USING(CATEGORY_NO)
        JOIN MEMBER M ON(BOARD_WRITER = MEMBER_NO)
        WHERE B.STATUS = 'Y'
        AND BOARD_TYPE = 1
        ORDER BY BOARD_NO DESC
	</select>
	<select id="searchAllBoard" resultMap="boardResultMap">
		SELECT  BOARD_NO, 
                CATEGORY_NAME,
                BOARD_TITLE,
                MEMBER_ID,
                COUNT,
                TO_CHAR(CREATE_DATE, 'YYYY-MM-DD') AS "CREATE_DATE"
        FROM BOARD B
        JOIN CATEGORY USING(CATEGORY_NO)
        JOIN MEMBER M ON(BOARD_WRITER = MEMBER_NO)
        WHERE B.STATUS = 'Y'
        AND BOARD_TYPE = 1
        <choose>
		 	<when test="condition == 'writer'">
		 		AND MEMBER_ID
		 	</when>
		 	<when test="condition == 'title'">
		 		AND BOARD_TITLE
		 	</when>
		 	<otherwise>
		 		AND BOARD_CONTENT
		 	</otherwise>
		 </choose>
		  LIKE '%${keyword}%'
        ORDER BY BOARD_NO DESC
	</select>
	<update id="increaseCount" parameterType="_int">
		UPDATE BOARD
		   SET COUNT = COUNT + 1
		 WHERE BOARD_NO = #{boardNo}
		   AND STATUS = 'Y'
	</update>
	<select id="selectBoardByBoardNo" parameterType="_int" resultMap="boardResultMap">
		SELECT BOARD_NO,
				CATEGORY_NAME,
				CATEGORY_NO,
				BOARD_TITLE,
				BOARD_CONTENT,
				MEMBER_ID,
				TO_CHAR(CREATE_DATE, 'YYYY-MM-DD') AS "CREATE_DATE"
		FROM BOARD B
		LEFT JOIN CATEGORY USING(CATEGORY_NO)
		JOIN MEMBER M ON(BOARD_WRITER = MEMBER_NO)
		WHERE B.STATUS = 'Y'
		AND BOARD_NO = #{boardNo}
	</select>
	<select id="selectAttachment" parameterType="_int" resultMap="attachmentResultMap">
		SELECT FILE_NO,
				ORIGIN_NAME,
				CHANGE_NAME,
				FILE_PATH,
				FILE_LEVEL
		  FROM ATTACHMENT
		 WHERE REF_BNO = #{refBoardNo}
	</select>
	<select id="selectAllCategory" resultMap="categoryResultMap">
		SELECT CATEGORY_NO,
				CATEGORY_NAME
		FROM CATEGORY
	</select>
	<insert id="insertBoard" parameterType="Board">
		INSERT
		INTO BOARD(
			BOARD_NO,
			BOARD_TYPE,
			CATEGORY_NO,
			BOARD_TITLE,
			BOARD_CONTENT,
			BOARD_WRITER
		) VALUES(
			SEQ_BNO.NEXTVAL,
			#{boardType},
			<if test="boardType == 1">
            	#{categoryNo},
	        </if>
	        <if test="boardType != 1">
	        	NULL,
	        </if>
			#{boardTitle},
			#{boardContent},
			#{boardWriter}
		)
	</insert>
	<insert id="insertAttachment" parameterType="Attachment">
		INSERT
		INTO ATTACHMENT(
			FILE_NO,
			REF_BNO,
			ORIGIN_NAME,
			CHANGE_NAME,
			FILE_PATH
		) VALUES(
			SEQ_FNO.NEXTVAL,
			SEQ_BNO.CURRVAL,
			#{originName},
			#{changeName},
			#{filePath}
		)
	</insert>
	<update id="deleteBoard" parameterType="_int">
		UPDATE BOARD
		SET STATUS = 'N'
		WHERE BOARD_NO = #{boardNo}
		AND STATUS = 'Y'
	</update>
	<update id="updateBoard" parameterType="Board">
		UPDATE BOARD
		   SET CATEGORY_NO = #{categoryNo},
				BOARD_TITLE = #{boardTitle},
				BOARD_CONTENT = #{boardContent}
		 WHERE BOARD_NO = #{boardNo}
		   AND STATUS = 'Y'
	</update>
	<update id="updateAttachment" parameterType="Attachment">
		UPDATE ATTACHMENT
		   SET 	ORIGIN_NAME = #{originName},
				CHANGE_NAME = #{changeName},
				FILE_PATH = #{filePath}
		 WHERE FILE_NO = #{fileNo}
	</update>
	<update id="insertNewAttachment" parameterType="Attachment">
		INSERT
		INTO ATTACHMENT(
			FILE_NO,
			REF_BNO,
			ORIGIN_NAME,
			CHANGE_NAME,
			FILE_PATH
		) VALUES(
			SEQ_FNO.NEXTVAL,
			#{refBoardNo},
			#{originName},
			#{changeName},
			#{filePath}
		)
	</update>
	<select id="selectReplyByBoardNo" parameterType="_int" resultMap="replyResultMap">
		SELECT REPLY_NO,
				REPLY_CONTENT,
				MEMBER_ID,
				TO_CHAR(CREATE_DATE, 'YYYY-MM-DD HH:MI') AS CREATE_DATE
		  FROM REPLY R
		  JOIN MEMBER M ON(REPLY_WRITER = MEMBER_NO)
		 WHERE R.STATUS = 'Y'
		   AND REF_BNO = #{refBoardNo}
		 ORDER BY REPLY_NO DESC
	</select>
	<insert id="insertReply" parameterType="Reply">
		INSERT
		INTO REPLY(
			REPLY_NO,
			REPLY_CONTENT,
			REF_BNO,
			REPLY_WRITER
		) VALUES(
			SEQ_RNO.NEXTVAL,
			#{replyContent},
			#{refBoardNo},
			#{replyWriter}
		)
	</insert>
	<delete id="deleteReply" parameterType="_int">
		DELETE 
		FROM REPLY
		WHERE REPLY_NO = #{replyNo}
	</delete>
	<select id="selectThumbnailList" resultMap="boardResultMap">
		SELECT  BOARD_NO, 
                BOARD_TITLE,
                COUNT,
           		FILE_PATH || CHANGE_NAME AS "THUMBNAIL_IMG"
        FROM BOARD B
        JOIN ATTACHMENT A ON(BOARD_NO = REF_BNO)
        WHERE B.STATUS = 'Y'
          AND BOARD_TYPE = 2
          AND FILE_LEVEL = 1
        ORDER BY BOARD_NO DESC
	</select>
	<insert id="insertThumbnailAttachment" parameterType="list">
	    INSERT INTO ATTACHMENT (
	        FILE_NO,
	        REF_BNO,
	        ORIGIN_NAME,
	        CHANGE_NAME,
	        FILE_PATH,
	        FILE_LEVEL
	    )
	    VALUES
	    <foreach collection="list" item="at" separator=",">
	        (
	            SEQ_FNO.NEXTVAL,
	            SEQ_BNO.CURRVAL,
	            #{at.originName},
	            #{at.changeName},
	            #{at.filePath},
	            #{at.fileLevel}
	        )
	    </foreach>
	</insert>
	<select id="selectAttachmentList" parameterType="_int" resultMap="boardResultMap">
		SELECT  BOARD_NO, 
                BOARD_TITLE,
                COUNT,
           		FILE_PATH || CHANGE_NAME AS "THUMBNAIL_IMG"
        FROM BOARD B
        JOIN ATTACHMENT A ON(BOARD_NO = REF_BNO)
        WHERE B.STATUS = 'Y'
          AND BOARD_TYPE = 2
          AND FILE_LEVEL = 1
          AND BOARD_NO = #{boardNo}
        ORDER BY BOARD_NO DESC
	</select>
</mapper>